[根目录](../CLAUDE.md) > **core**

# Core 模块文档

## 模块职责

Core 模块是 res-downloader 的后端核心，负责实现所有业务逻辑和底层功能。主要职责包括：

- 应用程序生命周期管理
- 多线程下载引擎
- HTTP 代理服务器
- 插件系统架构
- 配置管理和持久化
- 文件系统操作
- 跨平台系统适配

## 入口与启动

### 主要入口文件
- **`app.go`** - 应用程序主体，包含 App 结构体和生命周期管理
- **`main.go`** - 根目录入口，初始化 Wails 应用
- **`bind.go`** - Wails 绑定层，暴露 Go 函数给前端调用

### 启动流程
1. `main.go` 创建 Wails 应用实例
2. 初始化 `core.App` 单例
3. 创建 `core.Bind` 实例用于前后端通信
4. 设置菜单、窗口属性和资源服务器
5. 启动应用并调用 `app.Startup(ctx)`

## 对外接口

### Wails 绑定接口 (Bind)
- **`Config()`** - 获取全局配置信息
- **`AppInfo()`** - 获取应用基本信息（名称、版本等）
- **`ResetApp()`** - 重置应用状态并退出

### HTTP 服务接口
- **中间件处理** - 通过 `Middleware()` 函数处理 HTTP 请求
- **文件服务** - 提供静态资源和下载文件服务
- **API 端点** - 处理前端 API 请求

## 关键依赖与配置

### Go 依赖
- `github.com/wailsapp/wails/v2` - Wails v2 框架
- `github.com/elazarl/goproxy` - HTTP 代理库
- `github.com/rs/zerolog` - 结构化日志库
- `golang.org/x/net` - 网络扩展库

### 配置结构
主要配置项包含：
- **Theme** - 界面主题（light/dark）
- **Locale** - 语言设置（zh/en）
- **Host/Port** - 服务器地址和端口
- **Proxy** - 代理相关配置
- **Download** - 下载任务数量和线程设置
- **SaveDirectory** - 默认保存目录

## 数据模型

### 核心结构体
- **`App`** - 应用主结构，管理全局状态
- **`Config`** - 配置管理结构
- **`FileDownloader`** - 文件下载器
- **`Proxy`** - 代理服务器
- **`HttpServer`** - HTTP 服务器
- **`Resource`** - 资源管理器
- **`Logger`** - 日志管理器

### 下载相关模型
- **`DownloadTask`** - 下载任务单元
- **`ProgressChan`** - 进度通信通道
- **`ProgressCallback`** - 进度回调函数

## 子模块详情

### plugins 子模块
插件系统支持扩展下载功能：
- **`plugin.default.go`** - 默认插件处理通用下载
- **`plugin.qq.com.go`** - QQ 域名专用插件
- 支持插件动态加载和域名单独处理

### shared 子模块
共享组件和工具：
- **`const.go`** - 全局常量定义
- **`utils.go`** - 通用工具函数
- **`base.go`** - 基础结构和接口
- **`plugin.go`** - 插件接口定义

### 系统适配模块
- **`system_darwin.go`** - macOS 系统适配
- **`system_linux.go`** - Linux 系统适配
- **`system_windows.go`** - Windows 系统适配
- **`system.go`** - 通用系统接口

## 关键功能实现

### 多线程下载引擎
- 支持文件分片下载
- 可配置并发线程数
- 断点续传支持
- 错误重试机制

### HTTP 代理服务器
- 支持请求拦截和修改
- 插件化处理不同域名
- 支持 HTTPS 代理
- 请求/响应日志记录

### 插件系统架构
- 基于接口的插件定义
- 域名路由和插件匹配
- 请求/响应处理钩子
- 插件间数据共享机制

## 文件系统操作

### 存储管理
- **`storage.go`** - 文件存储管理
- 配置文件持久化
- 下载任务临时文件处理
- 文件名冲突解决策略

### 加密与安全
- **`aes.go`** - AES 加密实现
- 敏感数据加密存储
- 公私钥证书管理

## 测试与质量

### 当前状态
- ❌ 缺少单元测试文件
- ❌ 缺少集成测试
- ❌ 缺少性能基准测试
- ❌ 缺少代码覆盖率报告

### 质量工具
- 使用 `go fmt` 进行代码格式化
- 遵循 Go 官方编码规范
- 使用依赖管理工具 go mod

## 性能优化

### 并发处理
- 使用 goroutine 池管理下载任务
- 通过 channel 进行任务协调
- 避免资源竞争和内存泄漏

### 内存管理
- 及时释放大文件句柄
- 控制并发下载数量
- 优化日志内存占用

## 常见问题 (FAQ)

1. **Q: 如何添加新的网站插件？**
   A: 实现 `Plugin` 接口，注册到插件管理器，添加域名映射。

2. **Q: 下载速度慢如何优化？**
   A: 调整并发线程数，检查代理设置，确认网络带宽。

3. **Q: 如何调试插件问题？**
   A: 启用详细日志，检查域名匹配，验证请求/响应处理逻辑。

## 相关文件清单

### 核心文件
- `app.go` - 应用主体
- `bind.go` - 前后端绑定
- `downloader.go` - 下载引擎
- `proxy.go` - 代理服务器
- `config.go` - 配置管理

### 子模块
- `plugins/` - 插件系统
- `shared/` - 共享组件
- 系统适配文件

### 工具文件
- `utils.go` - 工具函数
- `logger.go` - 日志管理
- `http.go` - HTTP 工具
- `middleware.go` - 中间件

## 变更记录 (Changelog)

### 2025-11-20 - 模块初始化文档
- 创建 core 模块详细文档
- 分析核心结构和功能实现
- 识别测试和优化缺口

---

> 本文档由 AI 助手自动生成，基于代码结构分析